/************************************************************************/
/* AusBubble:                                                           */
/* An open-source RF jammer designed to operate in the 2.4 GHz Wi-Fi    */
/* frequency block.                                                     */
/*                                                                      */
/* RFPA5201_Amp.cpp                                                     */
/*                                                                      */
/* Will Robertson <aliask@gmail.com>                                    */
/* Nick D'Ademo <nickdademo@gmail.com>                                  */
/*                                                                      */
/* Copyright (c) 2012 Will Robertson, Nick D'Ademo                      */
/*                                                                      */
/* Permission is hereby granted, free of charge, to any person          */
/* obtaining a copy of this software and associated documentation       */
/* files (the "Software"), to deal in the Software without restriction, */
/* including without limitation the rights to use, copy, modify, merge, */
/* publish, distribute, sublicense, and/or sell copies of the Software, */
/* and to permit persons to whom the Software is furnished to do so,    */
/* subject to the following conditions:                                 */
/*                                                                      */
/* The above copyright notice and this permission notice shall be       */
/* included in all copies or substantial portions of the Software.      */
/*                                                                      */
/* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,      */
/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF   */
/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND                */
/* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  */
/* BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN   */
/* ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN    */
/* CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE     */
/* SOFTWARE.                                                            */
/*                                                                      */
/************************************************************************/

#include "RFPA5201_Amp.h"

/* Initialize static members */
bool RFPA5201_Amp::enabled = false;

/* RFPA5201 EVM: 11n MCS7 HT40; Vcc=5v; Vreg=2.9v; Temp=25degC; Duty Cycle=50% */
/* Data point format: {Po(dBm), f(MHz), Pdet(V)} */
const AmpDataPoint_t wifiN50duty25degC[N_DATA_POINTS] = {
        {0.57,2412,0.102129},
        {1.00,2412,0.103125},
        {1.50,2412,0.104331},
        {2.00,2412,0.105645},
        {2.50,2412,0.107123},
        {3.00,2412,0.108822},
        {3.50,2412,0.110801},
        {4.00,2412,0.113109},
        {4.50,2412,0.115752},
        {5.00,2412,0.118712},
        {5.50,2412,0.121977},
        {6.00,2412,0.125529},
        {6.50,2412,0.129354},
        {7.00,2412,0.133445},
        {7.50,2412,0.137873},
        {8.00,2412,0.142733},
        {8.50,2412,0.148129},
        {9.00,2412,0.154158},
        {9.50,2412,0.160922},
        {10.00,2412,0.168510},
        {10.50,2412,0.176967},
        {11.00,2412,0.186309},
        {11.50,2412,0.196557},
        {12.00,2412,0.207724},
        {12.50,2412,0.219831},
        {13.00,2412,0.232900},
        {13.50,2412,0.246982},
        {14.00,2412,0.262148},
        {14.50,2412,0.278474},
        {15.00,2412,0.296029},
        {15.50,2412,0.314884},
        {16.00,2412,0.335109},
        {16.50,2412,0.356733},
        {17.00,2412,0.379750},
        {17.50,2412,0.404154},
        {18.00,2412,0.429933},
        {18.50,2412,0.457087},
        {19.00,2412,0.485607},
        {19.50,2412,0.515681},
        {20.00,2412,0.547846},
        {20.50,2412,0.582675},
        {21.00,2412,0.620759},
        {21.50,2412,0.662662},
        {22.00,2412,0.708975},
        {22.50,2412,0.760017},
        {23.00,2412,0.814108},
        {23.50,2412,0.868959},
        {24.00,2412,0.925592},
        {24.50,2412,0.986681},
        {25.00,2412,1.053000},
        {25.50,2412,1.122000},
        {26.00,2412,1.199000},
        {26.50,2412,1.291000},
        {27.00,2412,1.394000},
        {27.50,2412,1.493000},
        {28.00,2412,1.582000},
        {28.50,2412,1.672000},
        {29.00,2412,1.766000},
        {29.50,2412,1.858000},
        {30.00,2412,1.949000},
        {30.50,2412,2.054000},
        {31.00,2412,2.168000},
        {31.50,2412,2.265000},
        {32.00,2412,2.348000},
        {32.50,2412,2.433000},
        {33.00,2412,2.512000},
        {33.50,2412,2.581000},
        {34.00,2412,2.648000},
        {34.50,2412,2.725000},
        {35.00,2412,2.791000},
        {0.83,2450,0.103384},
        {1.00,2450,0.103922},
        {1.50,2450,0.105509},
        {2.00,2450,0.107157},
        {2.50,2450,0.108910},
        {3.00,2450,0.110815},
        {3.50,2450,0.112917},
        {4.00,2450,0.115261},
        {4.50,2450,0.117887},
        {5.00,2450,0.120831},
        {5.50,2450,0.124126},
        {6.00,2450,0.127807},
        {6.50,2450,0.131907},
        {7.00,2450,0.136461},
        {7.50,2450,0.141508},
        {8.00,2450,0.147101},
        {8.50,2450,0.153290},
        {9.00,2450,0.160125},
        {9.50,2450,0.167661},
        {10.00,2450,0.175949},
        {10.50,2450,0.185034},
        {11.00,2450,0.194957},
        {11.50,2450,0.205760},
        {12.00,2450,0.217483},
        {12.50,2450,0.230164},
        {13.00,2450,0.243848},
        {13.50,2450,0.258599},
        {14.00,2450,0.274519},
        {14.50,2450,0.291717},
        {15.00,2450,0.310298},
        {15.50,2450,0.330370},
        {16.00,2450,0.352041},
        {16.50,2450,0.375404},
        {17.00,2450,0.400535},
        {17.50,2450,0.427504},
        {18.00,2450,0.456380},
        {18.50,2450,0.487229},
        {19.00,2450,0.520135},
        {19.50,2450,0.555185},
        {20.00,2450,0.592644},
        {20.50,2450,0.632811},
        {21.00,2450,0.675997},
        {21.50,2450,0.722506},
        {22.00,2450,0.772656},
        {22.50,2450,0.826708},
        {23.00,2450,0.884415},
        {23.50,2450,0.944988},
        {24.00,2450,1.008000},
        {24.50,2450,1.072000},
        {25.00,2450,1.141000},
        {25.50,2450,1.217000},
        {26.00,2450,1.305000},
        {26.50,2450,1.403000},
        {27.00,2450,1.508000},
        {27.50,2450,1.610000},
        {28.00,2450,1.704000},
        {28.50,2450,1.797000},
        {29.00,2450,1.893000},
        {29.50,2450,1.990000},
        {30.00,2450,2.084000},
        {30.50,2450,2.180000},
        {31.00,2450,2.281000},
        {31.50,2450,2.392000},
        {32.00,2450,2.500000},
        {32.50,2450,2.585000},
        {33.00,2450,2.663000},
        {33.50,2450,2.735000},
        {34.00,2450,2.803000},
        {34.50,2450,2.892000},
        {34.95,2450,2.922000},
        {0.84,2484,0.104555},
        {1.00,2484,0.105092},
        {1.50,2484,0.106835},
        {2.00,2484,0.108635},
        {2.50,2484,0.110536},
        {3.00,2484,0.112578},
        {3.50,2484,0.114808},
        {4.00,2484,0.117267},
        {4.50,2484,0.119999},
        {5.00,2484,0.123049},
        {5.50,2484,0.126462},
        {6.00,2484,0.130283},
        {6.50,2484,0.134557},
        {7.00,2484,0.139328},
        {7.50,2484,0.144648},
        {8.00,2484,0.150585},
        {8.50,2484,0.157200},
        {9.00,2484,0.164564},
        {9.50,2484,0.172740},
        {10.00,2484,0.181796},
        {10.50,2484,0.191796},
        {11.00,2484,0.202807},
        {11.50,2484,0.214898},
        {12.00,2484,0.228128},
        {12.50,2484,0.242569},
        {13.00,2484,0.258281},
        {13.50,2484,0.275325},
        {14.00,2484,0.293739},
        {14.50,2484,0.313557},
        {15.00,2484,0.334823},
        {15.50,2484,0.357573},
        {16.00,2484,0.381846},
        {16.50,2484,0.407681},
        {17.00,2484,0.435137},
        {17.50,2484,0.464288},
        {18.00,2484,0.495184},
        {18.50,2484,0.527890},
        {19.00,2484,0.562469},
        {19.50,2484,0.599036},
        {20.00,2484,0.638016},
        {20.50,2484,0.679928},
        {21.00,2484,0.725299},
        {21.50,2484,0.774659},
        {22.00,2484,0.828502},
        {22.50,2484,0.887330},
        {23.00,2484,0.950942},
        {23.50,2484,1.019000},
        {24.00,2484,1.090000},
        {24.50,2484,1.165000},
        {25.00,2484,1.245000},
        {25.50,2484,1.331000},
        {26.00,2484,1.424000},
        {26.50,2484,1.520000},
        {27.00,2484,1.618000},
        {27.50,2484,1.723000},
        {28.00,2484,1.833000},
        {28.50,2484,1.933000},
        {29.00,2484,2.023000},
        {29.50,2484,2.117000},
        {30.00,2484,2.221000},
        {30.50,2484,2.321000},
        {31.00,2484,2.420000},
        {31.50,2484,2.535000},
        {32.00,2484,2.637000},
        {32.50,2484,2.707000},
        {33.00,2484,2.788000},
        {33.50,2484,2.859000},
        {34.00,2484,2.924000},
        {34.31,2484,2.976000}
};

void RFPA5201_Amp::HWInit(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;

    // PENABLE
    // Note: Use external pull-down resistor (1k) on PENABLE to ensure amplifier is OFF at power-on
    GPIO_StructInit(&GPIO_InitStructure);
    GPIO_InitStructure.GPIO_Pin = AMP_PENABLE_PIN;
    GPIO_InitStructure.GPIO_Mode    = GPIO_Mode_OUT;
    GPIO_InitStructure.GPIO_OType   = GPIO_OType_PP;
    GPIO_InitStructure.GPIO_Speed   = GPIO_Speed_100MHz;
    GPIO_InitStructure.GPIO_PuPd    = GPIO_PuPd_NOPULL;
    GPIO_Init(AMP_PENABLE_PORT, &GPIO_InitStructure);
}

void RFPA5201_Amp::SetEnabled(bool enable)
{
    if(enable)
        GPIO_SetBits(AMP_PENABLE_PORT, AMP_PENABLE_PIN);
    else
        GPIO_ResetBits(AMP_PENABLE_PORT, AMP_PENABLE_PIN);

    /* Set internal flag */
    enabled = enable;
}
